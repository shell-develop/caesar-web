(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-03eb9cd0"],{"0462":function(t,e,s){"use strict";var n=s("634f"),r=s.n(n);r.a},"634f":function(t,e,s){},"67ee":function(t,e,s){"use strict";s.d(e,"h",(function(){return r})),s.d(e,"i",(function(){return a})),s.d(e,"j",(function(){return i})),s.d(e,"o",(function(){return o})),s.d(e,"e",(function(){return c})),s.d(e,"a",(function(){return l})),s.d(e,"b",(function(){return u})),s.d(e,"m",(function(){return d})),s.d(e,"c",(function(){return h})),s.d(e,"q",(function(){return m})),s.d(e,"f",(function(){return p})),s.d(e,"n",(function(){return f})),s.d(e,"d",(function(){return v})),s.d(e,"r",(function(){return k})),s.d(e,"g",(function(){return g})),s.d(e,"l",(function(){return b})),s.d(e,"k",(function(){return y})),s.d(e,"p",(function(){return x}));var n=s("9bd2");function r(t){return Object(n["a"])({url:"/server/task/command/executor",method:"post",data:t})}function a(t){return Object(n["a"])({url:"/server/task/playbook/executor",method:"post",data:t})}function i(t){return Object(n["a"])({url:"/server/task/script/executor",method:"post",data:t})}function o(t){return Object(n["a"])({url:"/server/task/query?taskId="+t,method:"get"})}function c(){return Object(n["a"])({url:"/server/task/ansible/hosts/create",method:"get"})}function l(t){return Object(n["a"])({url:"/server/task/abort?taskId="+t,method:"get"})}function u(t){return Object(n["a"])({url:"/server/task/member/abort?memberId="+t,method:"get"})}function d(t){return Object(n["a"])({url:"/server/task/playbook/page/query",method:"post",data:t})}function h(t){return Object(n["a"])({url:"/server/task/playbook/add",method:"post",data:t})}function m(t){return Object(n["a"])({url:"/server/task/playbook/update",method:"put",data:t})}function p(t){return Object(n["a"])({url:"/server/task/playbook/del?id="+t,method:"delete"})}function f(t){return Object(n["a"])({url:"/server/task/script/page/query",method:"post",data:t})}function v(t){return Object(n["a"])({url:"/server/task/script/add",method:"post",data:t})}function k(t){return Object(n["a"])({url:"/server/task/script/update",method:"put",data:t})}function g(t){return Object(n["a"])({url:"/server/task/script/del?id="+t,method:"delete"})}function b(){return Object(n["a"])({url:"/server/task/ansible/version",method:"get"})}function y(){return Object(n["a"])({url:"/server/task/ansible/hosts/preview",method:"get"})}function x(t){return Object(n["a"])({url:"/server/task/history/page/query",method:"post",data:t})}},"95ff":function(t,e,s){"use strict";var n=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("el-dialog",{attrs:{title:t.title,visible:t.formStatus.visible,width:"80%","before-close":t.handlerCloseDialog},on:{"update:visible":function(e){return t.$set(t.formStatus,"visible",e)}}},[t._l(t.xterms,(function(e){return s("div",{key:e},[[s("el-col",{attrs:{span:24}},[s("el-card",{staticStyle:{"margin-right":"10px","margin-bottom":"10px"},attrs:{shadow:"hover","body-style":"padding: 2px"}},[s("div",{staticClass:"clearfix",staticStyle:{height:"15px"},attrs:{slot:"header"},slot:"header"},[s("span",[s("el-tag",[t._v(" "+t._s(e))])],1),s("el-tooltip",{staticClass:"item",attrs:{effect:"light",content:"退出",placement:"top-start"}},[s("el-button",{staticStyle:{float:"right",padding:"3px 0"},attrs:{type:"text"},on:{click:function(s){return t.handlerLogout(e)}}},[t._v(" Logout ")])],1),s("el-tooltip",{staticClass:"item",attrs:{effect:"light",content:"复制会话",placement:"top-start"}},[s("el-button",{staticStyle:{float:"right",padding:"3px 0","margin-right":"20px"},attrs:{type:"text"},on:{click:function(e){return t.handlerDuplicateSession()}}},[t._v("Duplicate ")])],1)],1),s("div",{staticClass:"xterm",attrs:{id:e}})])],1)]],2)})),s("div",{staticClass:"dialog-footer",attrs:{slot:"footer"},slot:"footer"},[s("el-button",{attrs:{size:"mini"},on:{click:t.handlerExit}},[t._v("关闭")])],1)],2)},r=[],a=(s("4de4"),s("d81d"),s("b0c0"),s("1276"),s("c276")),i=(s("abb2"),s("fcf3")),o=s("47d0"),c=s("e232"),l="ws/xterm",u="XTERM",d={data:function(){return{title:"Web-XTerminal",socketURI:"",server:{},addonMap:[],xterms:[],xtermMap:{},timer:null,xtermSize:{rows:30},xtermTheme:{foreground:"#FFFFFF",background:"#606266",cursor:"help"}}},name:"XTerm",props:["formStatus"],mixins:[],mounted:function(){this.setXTermSetting(),this.initWebSocketURL()},beforeDestroy:function(){try{for(var t in this.socket.close(),this.xtermMap)this.xtermMap[t].dispose()}catch(e){}clearInterval(this.timer)},methods:{setXTermSetting:function(){var t=this;Object(c["a"])(u).then((function(e){if(e.success)try{t.xtermTheme.foreground=e.body["XTERM_FOREGROUND"],t.xtermTheme.background=e.body["XTERM_BACKGROUND"],t.xtermSize.rows=e.body["XTERM_ROWS"]||30}catch(s){}else t.$message.error(e.msg)}))},handlerExit:function(){this.handlerClose();try{for(var t in this.socket.close(),this.xtermMap)this.xtermMap[t].dispose()}catch(e){}this.formStatus.visible=!1},initData:function(t){this.server=t,this.handlerLogin()},initWebSocketURL:function(){var t=window.location.host,e=window.location.href.split("://")[0],s=("http"===e?"ws":"wss")+"://"+t+"/cs/"+l;this.socketURI=s},setTimer:function(){var t=this;this.timer=setInterval((function(){t.handlerSSHHeartbeat()}),1e4)},handlerSSHHeartbeat:function(){var t={status:"HEARTBEAT"};try{this.socketOnSend(JSON.stringify(t))}catch(e){}},initTermInstance:function(t){var e=this,s=t.name,n=new i["Terminal"]({rendererType:"canvas",allowTransparency:!0,fontSize:11,rows:this.xtermSize.rows,theme:this.xtermTheme,termName:"xterm",visualBell:!1,popOnBell:!1,scrollback:1e3,screenKeys:!1,debug:!1,cancelEvents:!1,cursorStyle:"underline",cursorBlink:!0,convertEol:!0});e.addonMap[s]=new o["FitAddon"],n.loadAddon(e.addonMap[s]),n.open(document.getElementById(s)),e.addonMap[s].fit(),n.focus(),n.onData((function(t){var n={data:t,status:"COMMAND",instanceId:s};e.socketOnSend(JSON.stringify(n))})),this.xtermMap[s]=n},handlerResize:function(){for(var t in this.xtermMap){this.addonMap[t].fit();var e={status:"RESIZE",instanceId:t,xtermWidth:7*this.addonMap[t]._terminal.cols,xtermHeight:document.getElementById(t).clientHeight};this.socketOnSend(JSON.stringify(e)),this.xtermMap[t].scrollToBottom()}},handlerDuplicateSession:function(){var t=this,e=this.server.name+"#"+a["a"].uuid(),s={status:"DUPLICATE_SESSION_IP",duplicateInstanceId:this.server.name,token:a["a"].cookies.get("token"),instanceId:e,xtermWidth:7*this.addonMap[e.split("#")[0]]._terminal.cols,xtermHeight:document.getElementById(e.split("#")[0]).clientHeight};this.xterms.push(e);var n={name:e,ip:this.server.privateIp};this.$nextTick((function(){t.initTermInstance(n),t.socketOnSend(JSON.stringify(s))}))},handlerLogout:function(t){var e={status:"LOGOUT",instanceId:t};this.socketOnSend(JSON.stringify(e));var s=this.xtermMap[t];s.dispose(),delete this.xtermMap[t],this.xterms=this.xterms.filter((function(e){return e!==t})),this.$message.warning(t+"终端已关闭")},handlerClose:function(){var t={status:"CLOSE"};this.socketOnSend(JSON.stringify(t)),this.xterms=[],this.xtermMap={},clearInterval(this.timer)},handlerCloseDialog:function(t){var e=this;this.$confirm("确定退出Web终端,并关闭所有会话?").then((function(s){t(),e.handlerExit()})).catch((function(t){}))},handlerLogin:function(){this.xtermMap={},this.initSocket(),this.setTimer()},initSocket:function(){this.socket=new WebSocket(this.socketURI),this.socketOnClose(),this.socketOnOpen(),this.socketOnError(),this.socketOnMessage()},socketOnOpen:function(){var t=this;this.socket.onopen=function(){try{t.xterms=[],t.xterms.push(t.server.name),t.$nextTick((function(){t.initTermInstance(t.server);var e={token:a["a"].cookies.get("token"),instanceId:t.server.name,ip:t.server.privateIp,status:"INITIAL_IP",xtermWidth:0,xtermHeight:308};t.socketOnSend(JSON.stringify(e)),t.$nextTick((function(){t.handlerResize()}))}))}catch(e){t.$message.error("登录失败，未选择服务器或其它原因")}}},socketOnClose:function(){this.socket.onclose=function(){}},socketOnError:function(){this.socket.onerror=function(){}},socketOnSend:function(t){this.socket.send(t)},socketOnMessage:function(){var t=this;this.socket.onmessage=function(e){var s=JSON.parse(e.data),n=t;s.map((function(t){n.xtermMap[t.instanceId].write(t.output)}))}}}},h=d,m=(s("0462"),s("2877")),p=function(t){t.options.__source="src/components/opscloud/xterm/XTerm.vue"},f=p,v=Object(m["a"])(h,n,r,!1,null,null,null);"function"===typeof f&&f(v);e["a"]=v.exports},ebec:function(t,e,s){"use strict";var n=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",[""!=t.serverTask&&null!=t.serverTask.memberMap?s("el-tabs",{attrs:{"tab-position":"top"},model:{value:t.activeName,callback:function(e){t.activeName=e},expression:"activeName"}},[null!=t.serverTask.memberMap.EXECUTE_QUEUE?s("el-tab-pane",{attrs:{name:"execute"}},[s("span",{attrs:{slot:"label"},slot:"label"},[s("i",{staticClass:"el-icon-loading"}),t._v(" 执行中")]),t._l(t.serverTask.memberMap.EXECUTE_QUEUE,(function(e){return s("el-card",{key:e.id,staticStyle:{"margin-top":"5px"},attrs:{shadow:"never"}},[s("el-row",[s("el-tag",{attrs:{"disable-transitions":""}},[t._v(t._s(e.hostPattern)+" - "+t._s(e.manageIp))]),s("el-tag",{style:{color:e.env.color,marginLeft:"5px"},attrs:{"disable-transitions":""}},[t._v(" "+t._s(e.env.envName)+" ")]),s("el-button",{staticStyle:{float:"right"},attrs:{type:"text"},on:{click:function(s){return t.abortServerTaskMember(e.id)}}},[t._v("停止")])],1),null!=e.outputMsgLog?s("d2-highlight",{staticStyle:{"margin-top":"5px"},attrs:{code:e.outputMsgLog}}):t._e()],1)}))],2):t._e(),null!=t.serverTask.memberMap.QUEUE?s("el-tab-pane",{attrs:{name:"queue"}},[s("span",{attrs:{slot:"label"},slot:"label"},[s("i",{staticClass:"el-icon-video-pause"}),t._v(" 队列")]),t._l(t.serverTask.memberMap.QUEUE,(function(e){return s("el-card",{key:e.id,staticStyle:{"margin-top":"5px"},attrs:{shadow:"never"}},[s("el-tag",{attrs:{"disable-transitions":""}},[t._v(t._s(e.hostPattern)+" - "+t._s(e.manageIp))]),s("el-tag",{style:{color:e.env.color,marginLeft:"5px"},attrs:{"disable-transitions":""}},[t._v(" "+t._s(e.env.envName)+" ")])],1)}))],2):t._e(),s("el-tab-pane",{attrs:{name:"finalized"}},[s("span",{attrs:{slot:"label"},slot:"label"},[s("i",{staticClass:"el-icon-check"}),t._v(" 完成")]),1===t.serverTask.finalized?s("div",[s("el-checkbox",{attrs:{indeterminate:t.isIndeterminate},on:{change:t.handleCheckAllChange},model:{value:t.checkAll,callback:function(e){t.checkAll=e},expression:"checkAll"}},[s("el-tag",{attrs:{size:"mini"}},[t._v(t._s(t.serverTask.taskStatistics.total))]),t._v(" 显示所有 ")],1),s("div",{staticStyle:{margin:"15px 0"}}),s("el-checkbox-group",{on:{change:t.handleCheckedResultsChange},model:{value:t.checkedResults,callback:function(e){t.checkedResults=e},expression:"checkedResults"}},t._l(t.resultOptions,(function(e){return s("el-checkbox",{key:e.key,attrs:{label:e.key}},[s("el-tag",{attrs:{size:"mini",type:e.type}},[t._v(t._s(e.count))]),t._v(" "+t._s(e.key)+" ")],1)})),1)],1):t._e(),t._l(t.serverTask.memberMap.FINALIZED,(function(e){return s("el-card",{directives:[{name:"show",rawName:"v-show",value:!e.hide,expression:"!member.hide"}],key:e.id,staticStyle:{"margin-top":"5px"},attrs:{shadow:"never"}},[s("el-row",[e.success?s("el-tag",{attrs:{"disable-transitions":"",color:"#5C887A"}},[s("span",{style:{color:"white"}},[t._v("success")])]):t._e(),e.success?t._e():s("el-tag",{attrs:{"disable-transitions":"",color:"#F56C6C"}},[s("span",{style:{color:"white"}},[t._v(t._s(e.taskResult))])]),s("el-tag",{style:{marginLeft:"5px"},attrs:{"disable-transitions":""}},[t._v(t._s(e.hostPattern)+" - "+t._s(e.manageIp)+" ")]),s("el-tag",{style:{color:e.env.color,marginLeft:"5px"},attrs:{"disable-transitions":""}},[t._v(" "+t._s(e.env.envName)+" ")]),s("el-button",{staticStyle:{float:"right","margin-right":"20px"},attrs:{type:"primary",plain:"",size:"mini"},on:{click:function(s){return t.handlerXTerm(e)}}},[t._v("登录 ")])],1),null==e.result&&null!=e.outputMsgLog?s("d2-highlight",{staticStyle:{"margin-top":"5px"},attrs:{code:e.outputMsgLog}}):t._e(),null!=e.result?s("d2-highlight",{staticStyle:{"margin-top":"5px"},attrs:{code:e.result.stdout}}):t._e(),e.showErrorLog?s("d2-highlight",{staticStyle:{"margin-top":"5px"},attrs:{code:e.errorMsgLog}}):t._e()],1)}))],2)],1):t._e(),s("XTerm",{ref:"xtermDialog",attrs:{formStatus:t.formXtermStatus}})],1)},r=[],a=s("95ff"),i=s("67ee"),o={data:function(){return{formXtermStatus:{visible:!1},serverTask:"",resultOptions:[],isIndeterminate:!0,checkAll:!0,checkedResults:[],timer:null,taskId:"",activeName:"",options:{stripe:!0},playbook:{},playbookOptions:[],labelWidth:"100px"}},name:"AnsibleResult",props:[],mixins:[],mounted:function(){},components:{XTerm:a["a"]},methods:{initData:function(t){this.timer=null,this.activeName="execute",this.taskId=t,this.queryTask(),this.setTimer()},handlerXTerm:function(t){this.formXtermStatus.visible=!0;var e={name:t.hostPattern,privateIp:t.manageIp};this.$refs.xtermDialog.initData(e)},handleCheckAllChange:function(t){this.checkedResults=t?["successful","failed","error"]:[],this.isIndeterminate=!1,this.setServerTaskMemberHide()},handleCheckedResultsChange:function(t){var e=t.length;this.checkAll=e===this.checkedResults.length,this.isIndeterminate=e>0&&e<this.checkedResults.length,this.setServerTaskMemberHide()},setServerTaskMemberHide:function(){for(var t=0;t<this.serverTask.memberMap.FINALIZED.length;t++){for(var e=this.serverTask.memberMap.FINALIZED[t],s=!0,n=0;n<this.checkedResults.length;n++)if(e.taskResult.toLowerCase()===this.checkedResults[n]){s=!1;break}e.hide=s}},setTimer:function(){var t=this;null==this.timer&&(this.timer=setInterval((function(){t.queryTask(),console.log("开始定时...每n秒执行一次")}),3e3))},handleDialogCancel:function(t){this.$message({message:"取消保存",type:"warning"}),t()},abortServerTask:function(t){var e=this;Object(i["a"])(t).then((function(t){t.success?e.$message({message:"任务停止中!",type:"success"}):e.$message.error(t.msg)}))},abortServerTaskMember:function(t){var e=this;Object(i["b"])(t).then((function(t){t.success?e.$message({message:"任务停止中!",type:"success"}):e.$message.error(t.msg)}))},queryTask:function(){var t=this;Object(i["o"])(this.taskId).then((function(e){if(t.serverTask=e.body,1===e.body.finalized){clearInterval(t.timer),t.resultOptions=[];var s={key:"successful",count:t.serverTask.taskStatistics.successfulCount,type:"success"};t.resultOptions.push(s);var n={key:"failed",count:t.serverTask.taskStatistics.failedCount,type:"warning"};t.resultOptions.push(n);var r={key:"error",count:t.serverTask.taskStatistics.errorCount,type:"danger"};t.resultOptions.push(r),t.checkedResults=["successful","failed","error"],t.activeName="finalized"}}))}}},c=o,l=s("2877"),u=function(t){t.options.__source="src/components/opscloud/ansible/AnsibleResult.vue"},d=u,h=Object(l["a"])(c,n,r,!1,null,"aacf9960",null);"function"===typeof d&&d(h);e["a"]=h.exports}}]);